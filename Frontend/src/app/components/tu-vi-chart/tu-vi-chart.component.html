<div class="tu-vi-chart" *ngIf="chart">
  <h2>L√Å S·ªê T·ª¨ VI</h2>
  
  <!-- Th√¥ng tin c∆° b·∫£n -->
  <div class="chart-info">
    <div class="info-item">
      <span class="label">Cung M·ªánh:</span>
      <span class="value">{{ getMenhBranch() }}</span>
    </div>
    <div class="info-item">
      <span class="label">Cung Th√¢n:</span>
      <span class="value">{{ getThanBranch() }}</span>
    </div>
    <div class="info-item">
      <span class="label">C·ª•c:</span>
      <span class="value">{{ getCuc() }}</span>
    </div>
    <div class="info-item">
      <span class="label">√Çm D∆∞∆°ng:</span>
      <span class="value">{{ getAmDuong() }}</span>
    </div>
    <div class="info-item">
      <span class="label">Tri·ªát:</span>
      <span class="value">{{ getTrietDisplay() }}</span>
    </div>
    <div class="info-item">
      <span class="label">Tu·∫ßn:</span>
      <span class="value">{{ getTuanDisplay() }}</span>
    </div>
  </div>
  
  <div class="chart-container">
    <!-- H√†ng 1: T·ªã - Ng·ªç - M√πi - Th√¢n -->
    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(6)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(6) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(6)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(6)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(6)" 
                 class="star" 
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(6)" 
                 class="star" 
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(6)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(7)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(7) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(7)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(7)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(7)" 
                 class="star" 
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(7)" 
                 class="star" 
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(7)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(8)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(8) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(8)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(8)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(8)" 
                 class="star" 
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(8)" 
                 class="star" 
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(8)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(9)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(9) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(9)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(9)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(9)" 
                 class="star" 
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(9)" 
                 class="star" 
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(9)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <!-- H√†ng 2: Th√¨n - Trung t√¢m - D·∫≠u -->
    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(5)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(5) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(5)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(5)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(5)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(5)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(5)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <div class="center-info" colspan="2">
      <div class="info-section">
        <h3>Th√¥ng Tin Sinh</h3>
        <p><strong>H·ªç t√™n:</strong> Nguy·ªÖn VƒÉn A</p>
        <p><strong>NƒÉm:</strong> {{ chart.lunarYear }}</p>
        <p><strong>Th√°ng:</strong> {{ chart.lunarMonth }}</p>
        <p><strong>Ng√†y:</strong> {{ chart.lunarDay }}</p>
        <p><strong>Gi·ªù:</strong> {{ formatTime(chart.birthTime) }}</p>
        <p><strong>Gi·ªõi t√≠nh:</strong> {{ chart.isMale ? 'Nam' : 'N·ªØ' }}</p>
      </div>
    </div>

    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(10)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(10) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(10)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(10)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(10)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(10)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(10)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <!-- H√†ng 3: M√£o - Trung t√¢m - Tu·∫•t -->
    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(4)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(4) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(4)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(4)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(4)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(4)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(4)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <div class="center-info" colspan="2">
      <div class="info-section">
        <p><strong>√Çm D∆∞∆°ng:</strong> {{ getAmDuong() }}</p>
        <p><strong>M·ªánh:</strong> {{ getMenh() }}</p>
        <p><strong>C·ª•c:</strong> {{ getCuc() }}</p>
      </div>
    </div>

    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(11)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(11) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(11)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(11)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(11)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(11)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(11)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <!-- H√†ng 4: D·∫ßn - S·ª≠u - T√Ω - H·ª£i -->
    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(3)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(3) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(3)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(3)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(3)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(3)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(3)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(2)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(2) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(2)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(2)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(2)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(2)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(2)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(1)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(1) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(1)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(1)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(1)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(1)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(1)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <div class="palace-cell" [attr.data-palace]="getPalaceByPosition(12)?.palaceName">
      <div class="palace-content">
        <div class="palace-header">
          <span class="palace-branch">{{ getPalaceBranchByPosition(12) }}</span>
          <span class="palace-name">{{ getPalaceByPosition(12)?.palaceName }}</span>
          <span class="palace-than" *ngIf="isThanPalace(12)">&lt;Th√¢n&gt;</span>
        </div>
        <div class="palace-stars">
          <div class="palace-stars-left">
            <div *ngFor="let star of getCatStars(12)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
          <div class="palace-stars-right">
            <div *ngFor="let star of getHungStars(12)"
                 class="star"
                 [ngClass]="getStarClass(star.starName, star.element)">
              {{ star.starName }}
            </div>
          </div>
        </div>
        <div class="truong-sinh-section">
          <div *ngFor="let star of getTruongSinhStars(12)" 
               class="star" 
               [ngClass]="getStarClass(star.starName, star.element)">
            {{ star.starName }}
          </div>
        </div>
      </div>
    </div>

    <!-- Tri·ªát v√† Tu·∫ßn indicators -->
    <div class="special-positions-overlay" *ngIf="chart">
      <div class="special-item combined-item" *ngIf="areSamePositions() && getTrietDisplay()">
        <span class="label">Tri·ªát-Tu·∫ßn:</span> <span class="value">{{ getTrietDisplay() }}</span>
      </div>
      <ng-container *ngIf="!areSamePositions()">
        <div class="special-item triet-item" *ngIf="getTrietDisplay()">
          <span class="label">Tri·ªát:</span> <span class="value">{{ getTrietDisplay() }}</span>
        </div>
        <div class="special-item tuan-item" *ngIf="getTuanDisplay()">
          <span class="label">Tu·∫ßn:</span> <span class="value">{{ getTuanDisplay() }}</span>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- AI Interpretation Section -->
  <div class="ai-interpretation-section">
    <h3>ü§ñ Lu·∫≠n Gi·∫£i AI</h3>
    
    <div class="interpretation-controls">
      <label for="focusArea">Lƒ©nh v·ª±c:</label>
      <select id="focusArea" [(ngModel)]="focusArea" (change)="onFocusAreaChange($event)">
        <option value="general">T·ªïng quan</option>
        <option value="career">S·ª± nghi·ªáp</option>
        <option value="love">T√¨nh duy√™n</option>
        <option value="health">S·ª©c kh·ªèe</option>
        <option value="wealth">T√†i l·ªôc</option>
      </select>
      
      <button 
        class="btn-interpret" 
        (click)="requestAIInterpretation()"
        [disabled]="isLoadingInterpretation">
        {{ isLoadingInterpretation ? 'ƒêang ph√¢n t√≠ch...' : 'Lu·∫≠n gi·∫£i b·∫±ng AI' }}
      </button>
    </div>

    <div *ngIf="interpretationError" class="interpretation-error">
      {{ interpretationError }}
    </div>

    <div *ngIf="isLoadingInterpretation" class="interpretation-loading">
      <div class="spinner"></div>
      <p>AI ƒëang ph√¢n t√≠ch l√° s·ªë c·ªßa b·∫°n...</p>
    </div>

    <div *ngIf="interpretation && !isLoadingInterpretation" class="interpretation-result">
      <div class="interpretation-overview">
        <h4>T·ªïng Quan</h4>
        <p>{{ interpretation.overallInterpretation }}</p>
      </div>

      <div *ngIf="interpretation.keyInsights.length > 0" class="interpretation-insights">
        <h4>ƒêi·ªÉm N·ªïi B·∫≠t</h4>
        <ul>
          <li *ngFor="let insight of interpretation.keyInsights">{{ insight }}</li>
        </ul>
      </div>

      <div *ngIf="interpretation.warnings.length > 0" class="interpretation-warnings">
        <h4>‚ö†Ô∏è C·∫£nh B√°o</h4>
        <ul>
          <li *ngFor="let warning of interpretation.warnings">{{ warning }}</li>
        </ul>
      </div>

      <div *ngIf="interpretation.recommendations.length > 0" class="interpretation-recommendations">
        <h4>üí° Khuy·∫øn Ngh·ªã</h4>
        <ul>
          <li *ngFor="let rec of interpretation.recommendations">{{ rec }}</li>
        </ul>
      </div>

      <div *ngIf="interpretation.palaceInterpretations.length > 0" class="palace-interpretations">
        <h4>Chi Ti·∫øt 12 Cung</h4>
        <div *ngFor="let palace of interpretation.palaceInterpretations" class="palace-detail">
          <h5>{{ palace.palaceName }}</h5>
          <p>{{ palace.interpretation }}</p>
          <div *ngIf="palace.influencingStars.length > 0" class="influencing-stars">
            <strong>Sao ·∫£nh h∆∞·ªüng:</strong> {{ palace.influencingStars.join(', ') }}
          </div>
        </div>
      </div>
    </div>
  </div>
